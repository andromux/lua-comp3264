name: Compilar Lua 5.3.X

on:
  # Permite la ejecuci√≥n manual desde la interfaz de GitHub
  workflow_dispatch:
    inputs:
      create_release:
        description: '¬øCrear release? (Ej: v1.0.0)'
        required: false
        type: string

jobs:
  compile-lua:
    # üö® CORRECCI√ìN 1: Aislamiento completo con contenedor para evitar interferencia entre 32/64 bits.
    container: ubuntu:22.04 
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [32, 64]
    
    steps:
      
      - name: Instalar paquetes base y dependencias
        run: |
          apt-get update
          # üö® CORRECCI√ìN 2: Instalamos 'sudo' para que la acci√≥n 'leafo/gh-actions-lua' funcione dentro del contenedor.
          apt-get install -y git wget ca-certificates build-essential file sudo
          
          # Solo para el job de 32 bits, instalamos las librer√≠as multilib
          if [ "${{ matrix.architecture }}" = "32" ]; then
            dpkg --add-architecture i386
            apt-get update
            apt-get install -y gcc-multilib g++-multilib libc6-dev-i386
          fi

      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Instalar Lua 5.3
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.3.6"
        env:
          # Forzamos las flags -m32 solo para el job de 32 bits.
          CFLAGS: ${{ matrix.architecture == 32 && '-m32' || '' }}
          LDFLAGS: ${{ matrix.architecture == 32 && '-m32' || '' }}
      
      - name: Verificar instalaci√≥n de Lua
        run: |
          echo "Verificando binario de luac (debe coincidir con ${{ matrix.architecture }} bits):"
          file $(which luac)
      
      - name: Crear carpeta de salida
        run: mkdir -p compilados_${{ matrix.architecture }}
      
      - name: Compilar archivos Lua para ${{ matrix.architecture }} bits
        # üö® CORRECCI√ìN 3: Usamos 'shell: bash' para que el comando 'shopt' funcione.
        shell: bash
        run: |
          echo "=== Compilando para ${{ matrix.architecture }} bits ==="
          shopt -s nullglob # Permite que el for loop no falle si no hay archivos .lua
          for archivo in *.lua; do
            nombre_base="${archivo%.lua}"
            salida="compilados_${{ matrix.architecture }}/${nombre_base}-${{ matrix.architecture }}.lua"
            echo "Compilando: $archivo -> $salida"
            if luac -s -o "$salida" "$archivo"; then
              echo "‚úì √âxito: $salida"
            else
              echo "‚úó Error al compilar $archivo"
              exit 1
            fi
          done

      - name: üõ°Ô∏è Test de Calidad (Verificar Arquitectura de Bytecode)
        # üö® CORRECCI√ìN 3: Usamos 'shell: bash' para que el comando 'shopt' funcione.
        shell: bash
        run: |
          echo "=== Verificando arquitectura (Byte 13: Size of size_t) ==="
          shopt -s nullglob
          for archivo in compilados_${{ matrix.architecture }}/*.lua; do
            echo -n "üìÑ $(basename $archivo): "
            # Usamos -s 13 (offset D) para leer el byte de arquitectura (size_t)
            size_byte=$(hexdump -s 13 -n 1 -e '1/1 "%02x"' "$archivo")
            
            if [ "$size_byte" = "04" ]; then
              echo "‚úÖ 32 bits detectado"
              if [ "${{ matrix.architecture }}" != "32" ]; then 
                echo "‚ùå ERROR: Se esperaba 64 bits. Compilaci√≥n fallida."
                exit 1
              fi
            elif [ "$size_byte" = "08" ]; then
              echo "‚úÖ 64 bits detectado"
              if [ "${{ matrix.architecture }}" != "64" ]; then 
                echo "‚ùå ERROR: Se esperaba 32 bits. Compilaci√≥n fallida."
                exit 1
              fi
            else
              echo "‚ö†Ô∏è Byte desconocido ($size_byte)"
            fi
          done
      
      - name: Comprimir archivos para release
        if: github.event.inputs.create_release != ''
        run: |
          cd compilados_${{ matrix.architecture }}
          tar -czf ../lua-compilados-${{ matrix.architecture }}bits-${{ github.event.inputs.create_release }}.tar.gz *
          cd ..
      
      - name: Subir artefactos compilados (Raw)
        uses: actions/upload-artifact@v4
        with:
          name: compilados-lua-${{ matrix.architecture }}bits
          path: compilados_${{ matrix.architecture }}/
          retention-days: 30

      - name: Subir tar.gz como artefacto (Para Release)
        if: github.event.inputs.create_release != ''
        uses: actions/upload-artifact@v4
        with:
          name: release-tarball-${{ matrix.architecture }}bits
          path: lua-compilados-${{ matrix.architecture }}bits-${{ github.event.inputs.create_release }}.tar.gz
          retention-days: 1

  create-release:
    needs: compile-lua
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release != ''
    permissions:
      contents: write
    
    steps:
      - name: Descargar todos los artefactos de release
        uses: actions/download-artifact@v4
        with:
          pattern: release-tarball-*
          path: ./release-files
          merge-multiple: true
      
      - name: Crear Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.create_release }}
          name: Release ${{ github.event.inputs.create_release }}
          files: ./release-files/*.tar.gz
          body: |
            ## üéâ Compilaci√≥n Lua 5.3.6
            
            Archivos compilados para 32 y 64 bits.
            
            ### üì¶ Archivos:
            - `32bits`: Bytecode compatible con binarios x86
            - `64bits`: Bytecode compatible con binarios x64
            
            ### üîç Verificaci√≥n (Linux/Mac):
            ```bash
            # Se usa -s 13 para obtener el byte de arquitectura (size_t)
            hexdump -s 13 -n 1 -e '1/1 "%02x\n"' archivo.lua
            # 04 = 32 bits
            # 08 = 64 bits
            ```
