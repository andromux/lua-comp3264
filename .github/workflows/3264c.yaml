name: Compilar Lua 5.3.X

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: '¬øCrear release? (Ej: v1.0.0)'
        required: false
        type: string

jobs:
  compile-lua:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [32, 64]
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Instalar dependencias (Solo 32 bits)
        if: matrix.architecture == 32
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib libc6-dev-i386

      - name: Instalar Lua 5.3
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.3.6"
        # ### CAMBIO IMPORTANTE: Forzar flags de compilaci√≥n para 32 bits
        env:
          CFLAGS: ${{ matrix.architecture == 32 && '-m32' || '' }}
          LDFLAGS: ${{ matrix.architecture == 32 && '-m32' || '' }}
      
      - name: Verificar instalaci√≥n de Lua
        run: |
          echo "Verificando binario:"
          file $(which lua)
          lua -v
          luac -v
      
      - name: Crear carpeta de salida
        run: mkdir -p compilados_${{ matrix.architecture }}
      
      - name: Compilar archivos Lua para ${{ matrix.architecture }} bits
        run: |
          echo "=== Compilando para ${{ matrix.architecture }} bits ==="
          # Compilar todos los archivos .lua en la ra√≠z
          shopt -s nullglob # Evita errores si no hay archivos .lua
          for archivo in *.lua; do
            nombre_base="${archivo%.lua}"
            salida="compilados_${{ matrix.architecture }}/${nombre_base}-${{ matrix.architecture }}.lua"
            
            echo "Compilando: $archivo -> $salida"
            # luac -s (strip debug info) -o (output)
            if luac -s -o "$salida" "$archivo"; then
              echo "‚úì √âxito: $salida"
            else
              echo "‚úó Error: $archivo"
              exit 1
            fi
          done

      - name: Verificar arquitectura de bytecode (Byte 12)
        run: |
          echo "=== Verificando arquitectura (Size of size_t) ==="
          shopt -s nullglob
          for archivo in compilados_${{ matrix.architecture }}/*.lua; do
            echo -n "üìÑ $(basename $archivo): "
            # Byte 12 en header Lua 5.3 indica sizeof(size_t)
            size_byte=$(hexdump -s 12 -n 1 -e '1/1 "%02x"' "$archivo")
            if [ "$size_byte" = "04" ]; then
              echo "‚úÖ 32 bits (Correcto)"
              if [ "${{ matrix.architecture }}" != "32" ]; then echo "‚ö†Ô∏è ALERTA: Se esperaba 64 bits"; exit 1; fi
            elif [ "$size_byte" = "08" ]; then
              echo "‚úÖ 64 bits (Correcto)"
              if [ "${{ matrix.architecture }}" != "64" ]; then echo "‚ö†Ô∏è ALERTA: Se esperaba 32 bits"; exit 1; fi
            else
              echo "‚ö†Ô∏è Desconocido ($size_byte)"
            fi
          done
      
      - name: Comprimir archivos para release
        if: github.event.inputs.create_release != ''
        run: |
          cd compilados_${{ matrix.architecture }}
          tar -czf ../lua-compilados-${{ matrix.architecture }}bits-${{ github.event.inputs.create_release }}.tar.gz *
          cd ..
      
      - name: Subir artefactos compilados (Raw)
        uses: actions/upload-artifact@v4
        with:
          name: compilados-lua-${{ matrix.architecture }}bits
          path: compilados_${{ matrix.architecture }}/
          retention-days: 30

      - name: Subir tar.gz como artefacto (Para Release)
        if: github.event.inputs.create_release != ''
        uses: actions/upload-artifact@v4
        with:
          name: release-tarball-${{ matrix.architecture }}bits
          path: lua-compilados-${{ matrix.architecture }}bits-${{ github.event.inputs.create_release }}.tar.gz
          retention-days: 1

  create-release:
    needs: compile-lua
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release != ''
    permissions: # Importante para poder escribir releases
      contents: write
    
    steps:
      - name: Descargar todos los artefactos de release
        uses: actions/download-artifact@v4
        with:
          pattern: release-tarball-*
          path: ./release-files
          merge-multiple: true # ### CAMBIO IMPORTANTE: Evita subcarpetas
      
      - name: Listar archivos descargados
        run: ls -R ./release-files
      
      - name: Crear Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.create_release }}
          name: Release ${{ github.event.inputs.create_release }}
          files: ./release-files/*.tar.gz
          body: |
            ## üéâ Compilaci√≥n Lua 5.3.6
            
            Archivos compilados para 32 y 64 bits.
            
            ### üì¶ Archivos:
            - `32bits`: Bytecode compatible con binarios x86
            - `64bits`: Bytecode compatible con binarios x64
            
            ### üîç Verificaci√≥n (Linux/Mac):
            ```bash
            hexdump -s 12 -n 1 -e '1/1 "%02x\n"' archivo.lua
            # 04 = 32 bits
            # 08 = 64 bits
            ```
