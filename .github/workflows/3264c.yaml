name: Compilaci√≥n Lua 5.3.X (32-bit y 64-bit)

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: '¬øCrear release? (Ej: v1.0.0)'
        required: false
        type: string

###############################################
#             JOB DE COMPILACI√ìN 32-BIT       #
###############################################
  compile-32bit:
    runs-on: ubuntu-latest
    # Usamos un contenedor para aislar el entorno y evitar contaminar el job de 64 bits.
    container: ubuntu:22.04 
    
    steps:
      - name: Instalar dependencias (32 bits)
        run: |
          apt-get update
          # Instalamos herramientas necesarias, sudo y multilib para 32 bits
          apt-get install -y git wget ca-certificates build-essential file sudo curl bsdmainutils
          dpkg --add-architecture i386
          apt-get update
          apt-get install -y gcc-multilib g++-multilib libc6-dev-i386

      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Instalar Lua 5.3 (Forzado 32 bits)
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.3.6"
        env:
          # Forzamos las flags de 32 bits
          CFLAGS: -m32
          LDFLAGS: -m32
      
      - name: Compilar archivos Lua para 32 bits
        shell: bash
        run: |
          echo "=== Compilando para 32 bits ==="
          mkdir -p compilados_32
          shopt -s nullglob
          for archivo in *.lua; do
            nombre_base="${archivo%.lua}"
            salida="compilados_32/${nombre_base}-32.lua"
            echo "Compilando: $archivo -> $salida"
            if luac -s -o "$salida" "$archivo"; then
              echo "‚úì √âxito: $salida"
            else
              echo "‚úó Error al compilar $archivo"
              exit 1
            fi
          done

      - name: üõ°Ô∏è Test de Calidad (Verificar 32 bits)
        shell: bash
        run: |
          archivo_test=$(ls compilados_32/*.lua | head -n 1)
          size_byte=$(hexdump -s 13 -n 1 -e '1/1 "%02x"' "$archivo_test")
          if [ "$size_byte" = "04" ]; then
            echo "‚úÖ Bytecode 32 bits detectado: $size_byte"
          else
            echo "‚ùå ERROR CR√çTICO: Se esperaba 32 bits (04) pero se detect√≥ ($size_byte)."
            exit 1
          fi

      - name: Comprimir y Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: compilados-lua-32bits
          path: compilados_32/
          retention-days: 30
      
      - name: Subir tar.gz como artefacto (Para Release)
        if: github.event.inputs.create_release != ''
        run: |
          cd compilados_32
          tar -czf ../lua-compilados-32bits-${{ github.event.inputs.create_release }}.tar.gz *
          cd ..
        uses: actions/upload-artifact@v4
        with:
          name: release-tarball-32bits
          path: lua-compilados-32bits-${{ github.event.inputs.create_release }}.tar.gz
          retention-days: 1


###############################################
#             JOB DE COMPILACI√ìN 64-BIT       #
###############################################
  compile-64bit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Instalar dependencias (64 bits)
        run: |
          # 64 bits es nativo, solo necesitamos herramientas base
          sudo apt-get update
          sudo apt-get install -y git wget ca-certificates build-essential file bsdmainutils

      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Instalar Lua 5.3 (Nativo 64 bits)
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.3.6"
        # No se necesitan CFLAGS/LDFLAGS especiales

      - name: Compilar archivos Lua para 64 bits
        shell: bash
        run: |
          echo "=== Compilando para 64 bits ==="
          mkdir -p compilados_64
          shopt -s nullglob
          for archivo in *.lua; do
            nombre_base="${archivo%.lua}"
            salida="compilados_64/${nombre_base}-64.lua"
            echo "Compilando: $archivo -> $salida"
            if luac -s -o "$salida" "$archivo"; then
              echo "‚úì √âxito: $salida"
            else
              echo "‚úó Error al compilar $archivo"
              exit 1
            fi
          done

      - name: üõ°Ô∏è Test de Calidad (Verificar 64 bits)
        shell: bash
        run: |
          archivo_test=$(ls compilados_64/*.lua | head -n 1)
          size_byte=$(hexdump -s 13 -n 1 -e '1/1 "%02x"' "$archivo_test")
          if [ "$size_byte" = "08" ]; then
            echo "‚úÖ Bytecode 64 bits detectado: $size_byte"
          else
            echo "‚ùå ERROR CR√çTICO: Se esperaba 64 bits (08) pero se detect√≥ ($size_byte)."
            exit 1
          fi

      - name: Comprimir y Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: compilados-lua-64bits
          path: compilados_64/
          retention-days: 30
      
      - name: Subir tar.gz como artefacto (Para Release)
        if: github.event.inputs.create_release != ''
        run: |
          cd compilados_64
          tar -czf ../lua-compilados-64bits-${{ github.event.inputs.create_release }}.tar.gz *
          cd ..
        uses: actions/upload-artifact@v4
        with:
          name: release-tarball-64bits
          path: lua-compilados-64bits-${{ github.event.inputs.create_release }}.tar.gz
          retention-days: 1


###############################################
#             JOB DE CREACI√ìN DE RELEASE      #
###############################################
  create-release:
    # Depende de que ambos jobs de compilaci√≥n hayan finalizado con √©xito
    needs: [compile-32bit, compile-64bit]
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release != ''
    permissions:
      contents: write
    
    steps:
      - name: Descargar todos los artefactos de release
        uses: actions/download-artifact@v4
        with:
          # Descarga los tarballs de 32 bits y 64 bits
          pattern: release-tarball-*
          path: ./release-files
          merge-multiple: true
      
      - name: Crear Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.create_release }}
          name: Release ${{ github.event.inputs.create_release }}
          # Adjunta ambos tarballs descargados
          files: ./release-files/*.tar.gz
          body: |
            ## üéâ Compilaci√≥n Lua 5.3.6
            
            Archivos compilados para 32 y 64 bits.
            
            ### üì¶ Archivos:
            - `32bits`: Bytecode compatible con binarios x86
            - `64bits`: Bytecode compatible con binarios x64
            
            ### üîç Verificaci√≥n (Linux/Mac):
            ```bash
            # Se usa -s 13 para obtener el byte de arquitectura (size_t)
            hexdump -s 13 -n 1 -e '1/1 "%02x\n"' archivo.lua
            # 04 = 32 bits
            # 08 = 64 bits
            ```
