name: Compilar Lua 5.3.X

on:
  workflow_dispatch: # Solo ejecuciÃ³n manual

jobs:
  compile-lua:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        architecture: [32, 64]
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          if [ "${{ matrix.architecture }}" = "32" ]; then
            sudo dpkg --add-architecture i386
            sudo apt-get update
            sudo apt-get install -y gcc-multilib g++-multilib libc6-dev-i386
          fi
      
      - name: Instalar Lua 5.3
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.3.6"
      
      - name: Verificar instalaciÃ³n de Lua
        run: |
          lua -v
          luac -v
      
      - name: Crear carpeta de salida
        run: |
          mkdir -p compilados_${{ matrix.architecture }}
      
      - name: Compilar archivos Lua para ${{ matrix.architecture }} bits
        run: |
          echo "==================================================="
          echo "  Compilando archivos para ${{ matrix.architecture }} bits"
          echo "==================================================="
          # Compilar todos los archivos .lua en la raÃ­z
          for archivo in *.lua; do
            if [ -f "$archivo" ]; then
              nombre_base="${archivo%.lua}"
              salida="compilados_${{ matrix.architecture }}/${nombre_base}-${{ matrix.architecture }}.lua"
              echo "Compilando: $archivo -> $salida"
              if luac -s -o "$salida" "$archivo"; then
                echo "âœ“ Compilado exitosamente: $salida"
              else
                echo "âœ— Error al compilar: $archivo"
                exit 1
              fi
            fi
          done
          echo ""
          echo "==================================================="
          echo "  Resumen de compilaciÃ³n"
          echo "==================================================="
          echo "Archivos compilados:"
          ls -lh compilados_${{ matrix.architecture }}/
          echo "==================================================="
      
      - name: Subir artefactos compilados
        uses: actions/upload-artifact@v4
        with:
          name: compilados-lua-${{ matrix.architecture }}bits
          path: |
            compilados_${{ matrix.architecture }}/
            compilados-${{ matrix.architecture }}bits.tar.gz
          retention-days: 30
      
      - name: Crear Release (solo en tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: compilados-${{ matrix.architecture }}bits.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    needs: compile-lua
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Resumen de compilaciÃ³n
        run: |
          echo "ðŸŽ‰ Proceso de compilaciÃ³n completado"
          echo "âœ… Arquitecturas compiladas: 32-bit y 64-bit"
          echo "ðŸ“¦ Los artefactos estÃ¡n disponibles en la pestaÃ±a 'Actions'"
